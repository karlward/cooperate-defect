<!DOCTYPE html>
<html>
<head>
  <script src="http://localhost/~kw1213/Networks/cooperate-defect/browser/src/lib/d3/d3.v3.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="http://localhost/~kw1213/Networks/cooperate-defect/browser/src/lib/jquery/jquery-2.0.3.min.js" type="text/javascript"></script>
  <script src="http://localhost:8000/socket.io/socket.io.js" type="text/javascript"></script>

  <script type="text/javascript">
    var cd = new Object(); // for cooperate-defect package globals
    
    // when DOM is ready, pull in state from game server, call initScreen
    $(document).ready(function() {
      //console.log('in getGame()');
      d3.json('http://localhost:8000/games/1', function(err, json) {
        if (err) {
          return console.warn(err);
        }
        //console.log('got JSON');
        cd.data = json;
        initScreen();
      });
      
      // capture controller keys
      $('input#controller').keydown(function(e) {
        console.log('checkKey fired');
        e = e || window.event;
        var move = null;
        if (e.keyCode == '38') { // up arrow
          move = 'up';
        }
        else if (e.keyCode == '40') { // down arrow
          move = 'down';
        }
        else if (e.keyCode == '37') { // left arrow
          move = 'left';
        }
        else if (e.keyCode == '39') { // right arrow
          move = 'right';
        }
        if (!!move) {
          $.ajax({
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            url: 'http://localhost:8000/players/0',
            type: 'PATCH',
            data: JSON.stringify({"move": move}),
            success: function() {
              //console.log("PATCH succeeded for up movement");
            },
            error: function() {
              //console.log("PATCH failed for up movement");
            }
          });
        }
      });
    });

    // initial setup of the screen, which is just an SVG element in the browser window
    var initScreen = function() {
      var svg = d3.select('body')
        .append('svg:svg')
        .attr('width', cd.data.screen["width"])
        .attr('height', cd.data.screen["height"]);

      // store d3 elements for players in a convenient variable
      cd.players = svg.selectAll('circle')
        .data(cd.data.players)
        .enter()
        .append('circle')
        .attr('class', 'player');
      
      // this is what redraws each frame
      window.setInterval(updateFrame, 1000/cd.data.screen.frameRate);
    }

    // get fresh state from game server
    var getGameData = function() {
      //console.log('in getGameData()');
      d3.json('http://localhost:8000/games/16', function(err, json) {
        if (err) {
          return console.warn(err);
        }
        cd.data = json;
        cd.players.data(cd.data.players);
      });
    };
    
    // actually move elements to match game state
    var updateFrame = function() {
      //console.log('in updateFrame() at frame rate ' + cd.data.screen.frameRate);
      getGameData();
      cd.players.transition()
        .attr('cx', function(d) {
          return d.x;
        })
        .attr('cy', function(d) {
            return d.y;
        })
        .attr('r', function(d) {
          return d.radius;
        })
        .attr('fill', function(d) {
          return d.color;
        })
        .attr('stroke', 'black');
    };

  </script>
</head>
<body>
  <input id="controller" type="text" autofocus="autofocus" />
</body>
</html>
